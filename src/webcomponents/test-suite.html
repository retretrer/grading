<!--
This component describes a suite of tests.

It creates a series of tests (<active-test>) as defined in the
grader.js file.

The component listens for 'test-passed' events from its tests.
When all tests pass, it emits a 'suite-passed' event to the 
<test-widget>.
-->

<link rel="import" href="/frontend-grading-engine/src/webcomponents/active-test.html">

<template id="test-suite">
  <style scoped>
    .suite {
      width: 100%;
      margin-bottom: 10px;
    }
    .suite-title {
      font-size: 1.25em;
    }
    .suite-code {
      background: rgba(0,0,0,0.6);
      color: #EEE;
      margin: 6px -0.5em;
    }
    .suite-code > div {
      padding: 6px 0.5em;
      text-align: center;
    }
    img {
      height: 2.25em;
      margin-bottom: -0.75em;
    }
  </style>
  <div class="suite">
    <div class="suite-title"></div>
    <div class="active-tests"></div>
    <button class="add-test" onclick="createTest();">+</button>
    <div class="suite-code"></div>
  </div>
</template>

<script>
  (function() {
    'use strict';
    var importDoc = document.currentScript.ownerDocument;
    var proto = Object.create(HTMLElement.prototype);

    proto.createdCallback = function() {
      var template = importDoc.querySelector('#test-suite');
      var clone = document.importNode(template.content, true);
      var root = this.createShadowRoot();
      root.appendChild(clone);
    };

    proto.attachedCallback = function() {
      var suiteName = this.suite.name;
      var suiteCode = this.suite.code || false;

      var suite = this.shadowRoot.querySelector('.suite');
      var sc = this.shadowRoot.querySelector('.suite-code');
      this.shadowRoot.querySelector('.suite-title').innerHTML = suiteName + " Tests";
    
      function displayCode() {
        sc.innerHTML = "<div>" + suiteName + " Code: " + suiteCode + "</div>";
      };

      var numberOfMandatoryTests = 0;
      var eventCollector = [];
      this.addEventListener('test-status', function (e) {
        // e.detail includes index, testCorrect, testDesc
        eventCollector[e.detail.index] = e.detail;
        if (eventCollector.length === numberOfMandatoryTests) {
          var allTestsPassed = eventCollector.every(function(val, index, arr) {
            return val.testCorrect;
          })
          if (allTestsPassed) {
            var passEvent = new CustomEvent('suite-passed', {'detail': suiteName});
            suite.dispatchEvent(passEvent);
            if (suiteCode) {
              displayCode();
            }
          }
        }
      });

      var testObserver = {
        tests: [],
        registerTest: function (test) {
          this.tests.push(test.index);
        },
        hasTest: function (test) {
          var inTests = false;
          (this.tests.indexOf(test.index) > -1) ? inTests = true : inTests = false;
          return inTests;
        }
      }

      function createTest(newTest) {
        var activeTest = document.createElement('active-test');
        var activeTests = suite.querySelector('.active-tests');
        activeTest.testDefinition = newTest;
        activeTest.index = newTest.index;
        if (!newTest.flags.optional) {
          numberOfMandatoryTests +=1;
        }
        activeTests.appendChild(activeTest);

        testObserver.registerTest(newTest);
      }

      this.suite.tests.forEach(function(test, index, arr) {
        test.index = index;
        createTest(test);
      })

      Array.observe(this.suite.tests, function(change) {
        if (change[0].type === 'splice') {
          createTest(change[0].object[0]);
        }
      })
    };

    document.registerElement('test-suite', {prototype: proto});
  })();
  function createTest() {
    
  };
</script>