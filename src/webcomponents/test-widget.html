<!--
This component (<test-widget>) describes the grader as a whole.

It creates suites of tests (<test-suite>) as defined in the
grader.js file.

Listens for 'suite-passed' events. Emits a 'grader-passed' event
when all suites pass.
-->

<link rel="import" href="/frontend-grading-engine/src/webcomponents/test-suite.html">
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro">

<template id="test-widget">
  <style scoped>
    * {
      font-family: 'Source Sans Pro', sans-serif;
    }

    .test-widget-display {
      position: absolute;
      min-width: 200px;
      max-width: 400px;
      background-color: rgba(230, 230, 230, 0.8);
      opacity: 0.5;
      right: 0px;
      top: 0px;
      padding: 0.5em;
      text-align: left;
      max-height: 100%;
      overflow-y: auto;
      transition: opacity 0.3s, max-height 0.3s;;
    }

    @media screen and (max-width: 800px) {
      .test-widget-display {
        max-width: 300px;
        max-height: 100vh;
        overflow-y: scroll;
      }
    }

    .test-widget-display:hover {
      opacity: 1;
    }

    .udacity-header {
      font-size: 2em;
    }

    .toggle_display {
      display: inline;
      height: 2em;
    }

    button.shown::before {
      content: "Hide";
    }

    button.hidden::before {
      content: "Show";
    }

    .small-display {
      max-height: 60px;
      overflow-y: hidden;
    }
  </style>
  <div class="test-widget-display">
    <div class="udacity-header">Udacity Feedback</div><button class="toggle_display shown"> Test Results</button>
  </div>
</template>

<script>
  (function() {
    var importDoc = document.currentScript.ownerDocument; // importee

    // Define and register <test-widget>
    // that uses Shadow DOM and a template.
    var proto = Object.create(HTMLElement.prototype);

    proto.createdCallback = function() {
      // get template in import
      var template = importDoc.querySelector('#test-widget');

      // import template into
      var clone = document.importNode(template.content, true);

      var root = this.createShadowRoot();
      root.appendChild(clone);
    };

    proto.attachedCallback = function() {
      // var graderSuites = suites;
      var twd = this.shadowRoot.querySelector('.test-widget-display');

      window.onscroll = function() {
        twd.style.top = window.scrollY + "px";
      };

      window.onload = function() {
        twd.style.top = window.scrollY + "px";
      };

      twd.querySelector('.toggle_display').onclick = function() {
        twd.classList.toggle('small-display');
        twd.querySelector('.toggle_display').classList.toggle('hidden');
        twd.querySelector('.toggle_display').classList.toggle('shown');
      }

      var eventCollector = [];
      this.addEventListener('suite-passed', function(e) {
        if (eventCollector.indexOf(e.detail) === -1) {
          eventCollector.push(e.detail);
          if (eventCollector.length === GE.suites.length) {
            var passEvent = new CustomEvent('grader-passed', {'detail': 'TBD'});
            twd.dispatchEvent(passEvent);
          }
        }
      });

      function createSuite(newSuite) {
        var ts = document.createElement('test-suite');
        ts.suite = newSuite;
        twd.appendChild(ts);
      }

      // just in case suites in GE.suites are already there
      GE.suites.forEach(function(val, index, arr) {
        createSuite(val);
      })

      Array.observe(GE.suites, function(change) {
        if (change[0].type === 'splice') {
          change.forEach(function(val, index, arr) {
            createSuite(val.object[index]);
          })
        }
      })
    };

    document.registerElement('test-widget', {prototype: proto});
  })();
  
  var tw = document.createElement('test-widget');
  document.body.appendChild(tw);
</script>