<!--
This component (<test-editor>) describes the suite editor view.
-->

<template id="test-editor">
  <style scoped>
    .new::after {
      content: " New"
    }
  </style>
  <div class="test-editor">
    <button onclick="testWidget.seeResults();">back to results</button>
    <h4 class="suite-name"></h4>
    <label for="active-test-description">Description</label>
    <input id="active-test-description" type="text">
    <label for="active-test-input">Active Test</label>
    <input id="active-test-input" type="text" placeholder="broken at the moment">
    <label for="flags">Flags</label>
    <input id="flags" type="flags" placeholder="also broken">
    <button id="save-test" onclick="testEditor.saveTest();">Save</button>
  </div>
</template>

<script>
  var testEditor = (function() {
    'use strict';
    var exports = {};
    var importDoc = document.currentScript.ownerDocument; // importee
    var elemItself = null;

    // Define and register <test-widget>
    // that uses Shadow DOM and a template.
    var proto = Object.create(HTMLElement.prototype);

    proto.createdCallback = function() {
      // get template in import
      var template = importDoc.querySelector('#test-editor');

      // import template into
      var clone = document.importNode(template.content, true);

      var root = this.createShadowRoot();
      root.appendChild(clone);
    };

    proto.attachedCallback = function() {
      elemItself = this.shadowRoot.querySelector('.test-editor');
    };

    document.registerElement('test-editor', {prototype: proto});
    
    var currentSuite = null;
    var currentTest = null;

    function saveTest() {
      var assumedEditedDescription = elemItself.querySelector('#active-test-description').value;
      var assumedEditedTest = elemItself.querySelector('#active-test-input').value;

      var alwaysCorrect = function () {
        return {
          isCorrect: true,
          questions: []
        }
      }

      var testInView = {
        description: assumedEditedDescription,
        activeTest: assumedEditedTest || alwaysCorrect
        // flags: assumedEditedFlags
      }

      if (!elemItself.test) {
        currentSuite.element.createTest(testInView);
      } else {
        elemItself.test.update(testInView);
      }

      // TODO: show a quick confirmation. wait 1 second so the test gets registered.

      testWidget.seeResults();
    };
    exports.saveTest = saveTest;

    function setTest(test) {
      elemItself.test = test;
      var descriptionView = elemItself.querySelector('#active-test-description');
      // var activeTestView = elemItself.querySelector('#active-test-input');
      descriptionView.value = test.description;
      // activeTestView.value = test.activeTest;
    }
    exports.setTest = setTest;

    function setCurrentSuite(suite) {
      currentSuite = suite;
      elemItself.querySelector('h4.suite-name').innerHTML = currentSuite.name;
    }
    exports.setCurrentSuite = setCurrentSuite;

    return exports;
  })();
  
</script>