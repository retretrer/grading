<!--
This component describes a single test.

It creates a setInterval to run the test function as defined in the
grader.js file.

The test bubbles an 'test-passed' event to the <test-suite> when it passes.
-->

<template id="active-test">
  <style scoped>
    .correct {
      color: #060;
    }
    .correct::before {
      content: "✓ ";
    }
    .incorrect {
      color: #900;
    }
    .incorrect::before {
      content: "✗ ";
    }
    .test-desc {
      width: 100%;
    }
  </style>
  <div class="test-desc incorrect"></div>
</template>
<script>
  (function() {
    var importDoc = document.currentScript.ownerDocument;
    var proto = Object.create(HTMLElement.prototype);

    proto.createdCallback = function() {
      // I call them 'active-tests' because they run themselves
      var template = importDoc.querySelector('#active-test');
      var clone = document.importNode(template.content, true);
      var root = this.createShadowRoot();
      root.appendChild(clone);
    };

    proto.attachedCallback = function() {
      var testFunc = this.test.func;
      var testParams = this.test.params;
      var testDesc = this.test.desc;
      var noRepeat = this.test.noRepeat || false;
      var async = this.test.async || false;

      var td = this.shadowRoot.querySelector('.test-desc');
      td.innerHTML = testDesc;
      
      /*
      Thanks StackOverflow!
      http://stackoverflow.com/questions/359788/how-to-execute-a-javascript-function-when-i-have-its-name-as-a-string
      */
      function executeFunctionByName(functionName, context) {
        var args = [].slice.call(arguments).splice(2);
        var namespaces = functionName.split(".");
        var func = namespaces.pop();
        for(var i = 0; i < namespaces.length; i++) {
          context = context[namespaces[i]];
        }
        return context[func].apply(this, args);
      }

      var testCorrect = false;
      var gradeRunner = setInterval(function() {
        // testCorrect = executeFunctionByName(testFunc, grader, testParams);
        // testCorrect = grader[testFunc](testParams);
        
        // TODO: if async flag is on, then use a promise to check the test when it resolves?

        try {
          testCorrect = grader[testFunc](testParams);
        } catch (e) {
          // TODO: make this more useful
          throw new Error("Test: " + testFunc + " failed to execute with args:" + testParams[0]);
        }
        if (noRepeat) clearInterval(gradeRunner);
        if (testCorrect) {
          td.classList.toggle('incorrect');
          td.classList.toggle('correct');
          var passEvent = new CustomEvent('test-passed', {'detail': testDesc});
          td.dispatchEvent(passEvent);
          clearInterval(gradeRunner);
        }
      }, 1000)

    };

    document.registerElement('active-test', {prototype: proto});
  })();
</script>