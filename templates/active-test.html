<template id="active-test">
  <style scoped>
    .correct {
      color: #060;
    }
    .correct::before {
      content: "✓ ";
    }
    .incorrect {
      color: #900;
    }
    .incorrect::before {
      content: "✗ ";
    }
    .test-desc {
      width: 100%;
    }
  </style>
  <div class="test-desc incorrect"></div>
</template>
<script>
  (function() {
    var importDoc = document.currentScript.ownerDocument; // importee

    // Define and register <shadow-element>
    // that uses Shadow DOM and a template.
    var proto = Object.create(HTMLElement.prototype);

    proto.createdCallback = function() {
      // get template in import
      var template = importDoc.querySelector('#active-test');

      // import template into
      var clone = document.importNode(template.content, true);

      var root = this.createShadowRoot();
      root.appendChild(clone);
    };

    proto.attachedCallback = function() {
      var testFunc = this.test.func;
      var testParams = this.test.params;
      var testDesc = this.test.desc;

      var td = this.shadowRoot.querySelector('.test-desc');
      td.innerHTML = testDesc;
      
      /*
      Thank you StackOverflow!
      http://stackoverflow.com/questions/359788/how-to-execute-a-javascript-function-when-i-have-its-name-as-a-string
      */
      function executeFunctionByName(functionName, context) {
        var args = [].slice.call(arguments).splice(2);
        var namespaces = functionName.split(".");
        var func = namespaces.pop();
        for(var i = 0; i < namespaces.length; i++) {
          context = context[namespaces[i]];
        }
        return context[func].apply(this, args);
      }

      var testCorrect = false;
      var gradeRunner = setInterval(function() {
        testCorrect = executeFunctionByName(testFunc, grader, testParams);
        if (testCorrect) {
          td.classList.toggle('incorrect');
          td.classList.toggle('correct');
          var passEvent = new CustomEvent('test-passed', {'detail': testDesc});
          td.dispatchEvent(passEvent);
          clearInterval(gradeRunner);
        }
      }, 1000)

    };

    document.registerElement('active-test', {prototype: proto});
  })();
</script>